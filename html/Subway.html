<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Greater Bay Area on Track</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
    <!--D3.js-->
    <script charset="utf-8" src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

    <link href='Subway_styles.css' rel='stylesheet' />
</head>

<body>

<div id='map'></div>


<div class='map-overlay top'>
<div class='map-overlay-inner'>
        <h2>Greater Bay Area on Track</h2>

         
</div>
</div>
    
<div class='map-overlay-mid'> 
    <div class="miles"> <p> <strong>Metro Mileage</strong>  </p>
    <table>
        <tr>
            <th>City</th>
            <th>Miles</th>
        </tr>
        <tr>
            <td>Guangzhou</td>
            <td id="gz_mileage"> aaa </td>
        </tr>
        <tr>
            <td>Shenzhen</td>
            <td id="sz_mileage"> aaa </td>
        </tr>
        <tr>
            <td>Hongkong</td>
            <td id="hk_mileage"> aaa </td>
        </tr>
    </table>
    </div>
</div>   

<div class='map-overlay-bottom'>

    <div class='button'>
    <button class="button-57" role="button" id="metro"><span class="text">Metro</span><span>Metro on/off</span></button>
    <button class="button-57-orange" role="button" id="inter-city"><span class="text">Inter-City Rail</span><span>Inter-City Rail on/off</span></button>
    <button class="button-57-red" role="button" id="CRH"><span class="text">High-Speed Rail</span><span>High-Speed Rail on/off</span></button>
   
    <!-- <table> -->
    <tr><td><p class="cityfly"> Zoom to:   
        <a href="#" class="citylink" id="gz">Guangzhou</a> &nbsp;
        <a href="#" class="citylink" id="sz">Shenzhen</a> &nbsp;
        <a href="#" class="citylink" id="hk">Hongkong</a> &nbsp;
        <a href="#" class="citylink" id="mc">Macao</a></p>
     </td></tr>
    <!-- </table> -->
    </div>

    <div class="container">
  
  <div class="range-slider">
    <span id="year" class="rs-label">2030</span>
    <input id="slider" class="rs-range" type="range" value="2030" min="1980" max="2030">
  </div>
    </div>
    
    <p class="credit"> Interactive map for the railway transportation system of the Greater Bay Area including <span style="color: blue">metro</span>, <span style="color: orange">intercity railways</span> and <span style="color: red">high-speed railways</span>. <br> Data Sources: <a href="https://lbs.amap.com/news/js_mou">sources</a></p>
        
       
</div>
    
<script>
    
    var rangeSlider = document.getElementById("slider");
    var rangeBullet = document.getElementById("year");

rangeSlider.addEventListener("input", showSliderValue, false);
    
function showSliderValue() {
  rangeBullet.innerHTML = rangeSlider.value;
  rangeBullet.style.left = ((2030-rangeSlider.value) * -1.83 + 95.4) + "%";
}

</script>



<script>
    
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGFudGVjaGVuMDgyNSIsImEiOiJjbGQxbGhhOTExaXBuM250Z2d6MWhzMnloIn0.EEsuGRqk0Uj_e1Q90WqPfQ'; // Put your Mapbox Public Access token here

    // Load a new map in the 'map' HTML div
    var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/dantechen0825/clhkm4u2i01mf01qy2qaj4bf1', // style location
    center: [113.5, 22.8], // starting position [lng, lat]
    zoom: 7.8 // starting zoom
    });
    
    map.addControl(new mapboxgl.NavigationControl());





    map.on('load', function() {
        
        const layers = map.getStyle().layers;
        // Find the index of the first symbol layer in the map style.
        let firstSymbolId;
        for (const layer of layers) {
            if (layer.type === 'symbol') {
                firstSymbolId = layer.id;
                break;
            }
        }
       
        map.addLayer({
            id: 'bayarea',
                    type: 'line',
                    source: {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.9hm1prda' // Your Mapbox tileset Map ID
                    },
                    'source-layer': 'bayarea-av4uhk', // name of tilesets
                    'layout': {
                        'visibility': 'visible',
                        
                    },
                    paint: {
                        'line-color': 'black',
                        'line-opacity' : 0.6
                    },
            
            firstSymbolId   
            
        }); 


        map.addLayer({
                    id: 'Subway_test',
                    type: 'line',
                    source: {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.aj49aajt' // Your Mapbox tileset Map ID
                    },
                    'source-layer': 'Subway1-azy4ec', // name of tilesets
                    'layout': {
                        'visibility': 'visible'
                    },
                    paint: {
                        'line-color': 'blue',
                        'line-width':2
                    }
                  },
                      firstSymbolId   
                    );

    // add a invisible layer for mouse detect

        map.addLayer({
                    id: 'Subway_mousedetect',
                    type: 'line',
                    source: {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.aj49aajt' // Your Mapbox tileset Map ID
                    },
                    'source-layer': 'Subway1-azy4ec', // name of tilesets
                    'layout': {
                        'visibility': 'visible'
                    },
                    paint: {
                        'line-color': 'white',
                        'line-opacity': 0,
                        'line-width': 15
                    },
                // filter: ['==','name','empty']
                  },
                      firstSymbolId   
                    );

// Intercity rail stations  
        map.addLayer({
                id: 'IntercityRail_test',
                type: 'line',
                source: {
                    type: 'vector',
                    url: 'mapbox://dantechen0825.ce2ryvum' // Your Mapbox tileset Map ID
                },
                'source-layer': 'IntercityRail_05151-3qoxff', // name of tilesets
                'layout': {
                    'visibility': 'visible'
                },
                paint: {
                    'line-color': 'orange',
                    'line-width': 3
                }
                },
                    firstSymbolId   );
           
        map.addLayer({
                    id: 'HighspeedRail_test',
                    type: 'line',
                    source: {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.94vpl16f' // Your Mapbox tileset Map ID
                    },
                    'source-layer': 'HighspeedRail_05151-d9z4dt', // name of tilesets
                    'layout': {
                        'visibility': 'visible'
                    },
                    paint: {
                        'line-color': 'red',
                        'line-width': 3
                    }
                  },
                      firstSymbolId   );
        
// subway stations
            // Add the proportional circle layer to the map
            map.addLayer({
                    id: 'Subway_stations_test',
                    type: 'circle',
                    source: {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.4qo4zx9g' // Your Mapbox tileset Map ID
                    },
                    'source-layer': 'Subway_stations_0515-5wz60y', // name of tilesets

                    'layout': {
                        'visibility': 'visible',
                    },
                    
                    paint: {
                        'circle-color': 'blue',
                        'circle-opacity': 0.95,
                        'circle-stroke-width': {
                    stops: [[9, 0], [10, 2], [16, 3]]
                    },
                        'circle-stroke-color': '#000',
                        'circle-stroke-opacity': 1,
                        'circle-radius': {stops: [[10, 0], [11, 3], [14, 4], [18, 8]]},
                            },
                
                  },
                      firstSymbolId   );

            // Add metro stations' name label  
            map.addLayer({
                'id': 'stations_label',
                'type': 'symbol',
                'source': {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.cnrgs8f7' // Your Mapbox tileset Map ID
                    },
                'source-layer': 'Subway_stations_0521-9qvpng', // name of tilesets
                'layout': {
                // get the title name from the source's "title" property
                'text-field': ['concat', ['get', 'name_en'], '\n', ['get', 'station']],
                'text-font': [
                'Open Sans Semibold',
                'Arial Unicode MS Bold'
                ],
                'text-radial-offset': 1,
                'text-justify': 'auto',
                // add stops to scale font sizes in ems
                'text-size': {stops: [[10, 0],[15, 30]]},
                'text-anchor': 'top'
                },
                'paint': {'text-color': '#4e4e4e'},
            });  
        
         // Add the proportional circle layer to the map
            map.addLayer({
                    id: 'IntercityRail_stations_test',
                    type: 'circle',
                    source: {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.6qg02fyk' // Your Mapbox tileset Map ID
                    },
                    'source-layer': 'IntercityRail_stations_05151-cynyea', // name of tilesets
                    'layout': {
                        'visibility': 'visible'
                    },
                    paint: {
                        'circle-color': 'orange',
                        'circle-opacity': 0.95,
                        'circle-stroke-width': {
                    stops: [[9, 0], [10, 2], [16, 3]]
                    },
                        'circle-stroke-color': '#000',
                        'circle-stroke-opacity': 1,
                        'circle-radius': {stops: [[10, 0], [11, 3], [14, 4], [18, 8]]},
                            }
                  },
                      firstSymbolId   );
            // Add IntercityRail stations' name label  
            map.addLayer({
                'id': 'ICR_stations_label',
                'type': 'symbol',
                'source': {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.6qg02fyk' // Your Mapbox tileset Map ID
                    },
                'source-layer': 'IntercityRail_stations_05151-cynyea', // name of tilesets
                'layout': {
                // get the title name from the source's "title" property
                'text-field': ['concat', ['get', 'time'], '\n', ['get', 'name']],
                'text-font': [
                'Open Sans Semibold',
                'Arial Unicode MS Bold'
                ],
                'text-radial-offset': 1,
                'text-justify': 'auto',
                // add stops to scale font sizes in ems
                'text-size': {stops: [[10, 0],[15, 30]]},
                'text-anchor': 'top'
                },
                'paint': {'text-color': '#4e4e4e'},
            });  

            // Add the proportional circle layer to the map
            map.addLayer({
                    id: 'HighspeedRail_stations_test',
                    type: 'circle',
                    source: {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.csprwhc5' // Your Mapbox tileset Map ID
                    },
                    'source-layer': 'HSR_stations3-7krlog', // name of tilesets
                    'layout': {
                        'visibility': 'visible'
                    },
                    paint: {
                        'circle-color': 'red',
                        'circle-opacity': 0.95,
                        'circle-stroke-width': {
                    stops: [[7, 0], [9, 2], [14, 3]]
                    },
                        'circle-stroke-color': '#000',
                        'circle-stroke-opacity': 1,
                        'circle-radius': {stops: [[8, 0], [9, 3], [12, 4], [16, 8]]},
                            }
                  },
                      firstSymbolId   );
            map.addLayer({
                'id': 'HSR_stations_label',
                'type': 'symbol',
                'source': {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.csprwhc5' // Your Mapbox tileset Map ID
                    },
                'source-layer': 'HSR_stations3-7krlog', // name of tilesets
                'layout': {
                // get the title name from the source's "title" property
                'text-field': ['concat', ['get', 'time'], '\n', ['get', 'name']],
                'text-font': [
                'Open Sans Semibold',
                'Arial Unicode MS Bold'
                ],
                // 'text-offset': [0, 1.0],
                'text-radial-offset': 1,
                'text-justify': 'auto',
                // add stops to scale font sizes in ems
                'text-size': {stops: [[10, 0],[15, 30]]},
                'text-anchor': 'top'
                },
                'paint': {'text-color': '#4e4e4e'},
            }); 

//  Hoverlight layer
            map.addLayer({
                id: 'Subway_lines_hoverlight',  
                type: 'line',
                source: {
                    type: 'vector',
                    url: 'mapbox://dantechen0825.aj49aajt' // Your Mapbox tileset Map ID
                },
                'source-layer': 'Subway1-azy4ec', // name of tilesets
                'layout': {
                    'visibility': 'visible'
                },
                paint: {
                    'line-color': '#00DFFF',
                    // 'line-opacity': 0.8,
                    'line-width': 3
                },
                filter: ['==','name','empty']
                },
                    firstSymbolId   
                );  

            map.addLayer({
                id: 'IntercityRail_lines_highlight',
                type: 'line',
                source: {
                    type: 'vector',
                    url: 'mapbox://dantechen0825.ce2ryvum' // Your Mapbox tileset Map ID
                },
                'source-layer': 'IntercityRail_05151-3qoxff', // name of tilesets
                'layout': {
                    'visibility': 'visible'
                },
                paint: {
                    'line-color': 'YELLOW',
                    'line-width': 5
                },
                filter: ['==','name','empty']
                },
                    firstSymbolId   );
            
            map.addLayer({
                    id: 'HighspeedRail_lines_highlight',
                    type: 'line',
                    source: {
                      type: 'vector',
                      url: 'mapbox://dantechen0825.94vpl16f' // Your Mapbox tileset Map ID
                    },
                    'source-layer': 'HighspeedRail_05151-d9z4dt', // name of tilesets
                    'layout': {
                        'visibility': 'visible'
                    },
                    paint: {
                        'line-color': '#ff0000',
                        'line-width': 5
                    },
                filter: ['==','name','empty']
                  },
                      firstSymbolId   );


            // Mileage data 🥲
            // Notes: shouldn't have space between the comma and the next word!
                const csvData = `key,city1,city2,city3
1980,35.69,54.11,35.69
1981,28.67,55.11,28.67
1982,31.22,56.11,31.22
1983,-23.55,57.11,-23.55
1984,19.43,58.11,19.43
1985,23.71,59.11,23.71
1986,30.04,60.11,30.04
1987,39.91,61.11,39.91
1988,19.07,62.11,19.07
1989,34.68,63.11,34.68
1990,40.72,35.69,40.72
1991,24.91,28.67,24.91
1992,29.56,31.22,29.56
1993,41.01,-23.55,41.01
1994,-34.61,19.43,-34.61
1995,22.53,23.71,22.53
1996,6.45,30.04,6.45
1997,-4.33,39.91,-4.33
1998,14.6,19.07,14.6
1999,39.11,34.68,39.11
2000,41.01,40.72,41.01
2001,-34.61,24.91,-34.61
2002,22.53,29.56,22.53
2003,6.45,41.01,6.45
2004,-4.33,-34.61,-4.33
2005,14.6,22.53,14.6
2006,39.11,6.45,39.11
2007,40.11,-4.33,40.11
2008,41.11,14.6,41.11
2009,42.11,39.11,42.11
2010,43.11,41.01,43.11
2011,44.11,-34.61,44.11
2012,45.11,22.53,45.11
2013,46.11,6.45,46.11
2014,47.11,-4.33,47.11
2015,48.11,14.6,48.11
2016,49.11,39.11,49.11
2017,50.11,40.11,50.11
2018,51.11,41.11,51.11
2019,52.11,42.11,52.11
2020,53.11,43.11,53.11
2021,54.11,44.11,54.11
2022,55.11,45.11,55.11
2023,56.11,46.11,56.11
2024,57.11,47.11,57.11
2025,58.11,48.11,58.11
2026,59.11,49.11,59.11
2027,60.11,50.11,60.11
2028,61.11,51.11,61.11
2029,62.11,52.11,62.11
2030,63.11,53.11,63.11`;
                
                // Parse the CSV data
                const parsedData = Papa.parse(csvData, { header: true }).data;
                console.log(parsedData);
                // Convert to dictionary
                const dictionary = {};
                parsedData.forEach(row => {
                const key = row.key;
                const values = Object.keys(row).filter(k => k !== 'key').map(k => row[k]);
                dictionary[key] = values;
                });

                const data = dictionary;

                // let data = d3.csv("./data.csv"[[, row], callback])         



            // Assign an event listner to the slider so that the setYear function runs when the user changes the slider
            document.getElementById('slider').addEventListener('input', function(e) {

                document.getElementById('year').textContent = parseInt(e.target.value); 
                
                document.getElementById('gz_mileage').textContent = parseFloat(data[e.target.value][0]) + 'km'; 
                document.getElementById('sz_mileage').textContent = parseFloat(data[e.target.value][1]) + 'km'; 
                document.getElementById('hk_mileage').textContent = parseFloat(data[e.target.value][2]) + 'km'; 
                
                map.setFilter('Subway_stations_test', ['<=', 'time', parseInt(e.target.value)]);
                map.setFilter('stations_label', ['<=', 'time', parseInt(e.target.value)]);
                map.setFilter('Subway_test', ['<=', 'time', parseInt(e.target.value)]);
                map.setFilter('IntercityRail_test', ['<=', 'time', parseInt(e.target.value)]);
                map.setFilter('IntercityRail_stations_test', ['<=', 'time', parseInt(e.target.value)]);
                map.setFilter('HighspeedRail_test', ['<=', 'time', parseInt(e.target.value)]);
                map.setFilter('HighspeedRail_stations_test', ['<=', 'time', parseInt(e.target.value)]);
                });
        
        
        
        
        document.getElementById('metro').addEventListener('click', () => {
            
            if (map.getLayoutProperty('Subway_test', 'visibility') === 'visible') {
            map.setLayoutProperty('Subway_test', 'visibility', 'none');
            map.setLayoutProperty('Subway_stations_test', 'visibility', 'none')
        } else {
            map.setLayoutProperty('Subway_test','visibility','visible');
            map.setLayoutProperty('Subway_stations_test', 'visibility', 'visible')
        } 
        }); 

        
        document.getElementById('inter-city').addEventListener('click', () => {
            
            if (map.getLayoutProperty('IntercityRail_test', 'visibility') === 'visible') {
            map.setLayoutProperty('IntercityRail_test', 'visibility', 'none');
            map.setLayoutProperty('IntercityRail_stations_test', 'visibility', 'none')
        } else {
            map.setLayoutProperty('IntercityRail_test','visibility','visible');
            map.setLayoutProperty('IntercityRail_stations_test', 'visibility', 'visible')
        } 
        }); 
        
        
        
        document.getElementById('CRH').addEventListener('click', () => {
            
            if (map.getLayoutProperty('HighspeedRail_test', 'visibility') === 'visible') {
            map.setLayoutProperty('HighspeedRail_test', 'visibility', 'none');
            map.setLayoutProperty('HighspeedRail_stations_test', 'visibility', 'none');
        } else {
            map.setLayoutProperty('HighspeedRail_test','visibility','visible');
            map.setLayoutProperty('HighspeedRail_stations_test','visibility','visible');
        } 
        }); 

// Hover Popup 
    function processPopup(elementIds) {
        for (var i = 0; i < elementIds.length; i++) {
            var id = elementIds[i]

            // Perform operations on the element
            // Create a popup for subway line
            const popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false
                });
                
                map.on('mouseenter', id, (e) => {
                    
                    // Change the cursor style as a UI indicator.
                    map.getCanvas().style.cursor = 'pointer';
                    
                    // Copy coordinates of the mouse.
                    const coordinates = e.lngLat;
                    const description = "<strong>" + e.features[0].properties.name + "</strong>" + "<br> This segment of railway started operating in "  + e.features[0].properties.time + ".";
                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }
                    
                    // Populate the popup and set its coordinates
                    // based on the feature found.
                    popup.setLngLat(coordinates).setHTML(description).addTo(map);
                });
                
                map.on('mouseleave', id, () => {
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                }); 
        }
    };

        var ids = ['Subway_mousedetect', 'IntercityRail_test', 'HighspeedRail_test'];
        processPopup(ids);

        
// Hover Highlight
    function processHL(elementIds1, elementIds2) {
        for (var i = 0; i < elementIds1.length; i++) {
                var id1 = elementIds1[i];
                var id2 = elementIds2[i]
        
            map.on('mouseenter', id1, (e) => {
            // Highlight the subway line
                map.setFilter(id2, ['==','name',e.features[0].properties.name]); 
            });
                    
            // when mouse leaves the layer, update the filter so no features are highlighted
            map.on('mouseleave', id1, () => {
                map.setFilter(id2, ['==','name','empty']);
            });
    
        }
    };

    var ids1 = ['Subway_mousedetect'];
    // var ids1 = ['Subway_test', 'IntercityRail_test', 'HighspeedRail_test'];
    var ids2 = ['Subway_lines_hoverlight'];
    // var ids2 = ['Subway_lines_hoverlight','IntercityRail_lines_highlight','HighspeedRail_lines_highlight'];
    processHL(ids1, ids2);
       
    
    map.on('mouseenter', 'IntercityRail_test', (e) => {                    
        // Highlight the subway line
        map.setFilter('IntercityRail_lines_highlight', ['==','name',e.features[0].properties.name]); 
    });               
    // when mouse leaves the layer, update the filter so no features are highlighted
    map.on('mouseleave', 'IntercityRail_test', () => {
        map.setFilter('IntercityRail_lines_highlight', ['==','name','empty']);
    });

    map.on('mouseenter', 'HighspeedRail_test', (e) => {                    
        // Highlight the subway line
        map.setFilter('HighspeedRail_lines_highlight', ['==','name',e.features[0].properties.name]); 
    });                
    // when mouse leaves the layer, update the filter so no features are highlighted
    map.on('mouseleave', 'HighspeedRail_test', () => {
        map.setFilter('HighspeedRail_lines_highlight', ['==','name','empty']);
    });

});

// FLY TO
// Event listener for the zoom to buttons created using a for loop and switch case statement to set lat and long
var x = document.getElementsByClassName('citylink');
var i;
		for (i = 0; i < x.length; i++) {
			x[i].addEventListener('click', function(e) {

				var lat,long;

				switch(e.target.id) {
					case "gz": long=113.258057; lat=23.127731; break;
					case "sz": long=114.03; lat=22.550611; break;
					case "hk": long=114.158936; lat=22.281472; break;
					case "mc": long=113.560867; lat=22.161653; break;
				}

				map.flyTo({
					center: [long,lat],
					zoom: 10,
					speed: 0.5,
					});
			});
		}

</script>   
    


    

</body>
</html>
